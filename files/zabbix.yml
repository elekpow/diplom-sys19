---
- hosts: zabbix-elvm
  tasks:
  - name: say hello
    become: yes
    debug:
      msg: hello from {{ ansible_hostname }}
      
  - name: Update and upgrade apt packages
    become: true
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 #One day      
      
  - name: Install required packages
    become: true
    apt:
      name:
        - gnupg2
        - wget
        - acl
      state: latest         
                
  - name: Install python3
    become: true
    apt:
      name:
        - libpq-dev
        - python3
        - python3-psycopg2
      state: latest      
      
  - name: Install packages Postgresql
    become: true
    apt:
      name:
        - postgresql
        - postgresql-contrib
      state: present      

  - name: Install zabbix packages
    become: true
    apt:
      name:
        - zabbix-server-pgsql 
        - zabbix-frontend-php
        - php7.4-pgsql
      state: latest  
      update_cache: yes

      
      
  - name:  Set up zabbix-agent
    become: true
    apt:
      name:
        - zabbix-nginx-conf 
        - zabbix-sql-scripts
        - zabbix-agent
      state: latest


  - name: Create postgres user for my app
    become: yes
    become_user: postgres
    postgresql_user:
      name: "zabbix"
      password: "supersecretpassword"
      
      
  - name: create postgresql db
    postgresql_db:
      name: "zabbix"
      state: present
    become: true
    become_user: postgres      
      
    
  - name: Ensure we have access from the new user
    become: yes
    become_user: postgres
    postgresql_privs:
      db: zabbix
      role: zabbix
      objs: ALL_IN_SCHEMA
      privs: SELECT,INSERT,UPDATE,DELETE   
        
  - name: Initialize the database
    become: true
    shell: |
      zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | sudo -u zabbix psql zabbix
    args:
      warn: no
    register: hello   
   
    
  - name: DBPassword change
    become: true
    lineinfile: dest=/etc/zabbix/zabbix_server.conf
                regexp='^# DBPassword='
                insertbefore=BOF
                line='DBPassword=supersecretpassword' 
                
 
  - name: rm sites default
    become: true 
    command: rm /etc/nginx/sites-enabled/default
    args:
      removes: /etc/nginx/sites-enabled/default
      
  - name: copy local file zabbix.conf.php, adding some permissions and removing others
    become: true 
    copy:
      src: ../source/zabbix.conf.php
      dest: /etc/zabbix/web/zabbix.conf.php
      owner: www-data
      group: www-data
      mode: u+rw,g-wx,o-rwx

  - name: Restart zabbix-server
    become: true 
    service:
      name: zabbix-server
      state: restarted      
      
  - name: Restart service nginx
    become: true 
    service:
      name: nginx
      state: restarted
      
  - name: Enable service nginx
    become: true 
    service:
      name: nginx
      enabled: yes