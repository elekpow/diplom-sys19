---
- hosts: zabbix-elvm
  tasks:
  - name: say hello
    become: yes
    debug:
      msg: hello from {{ ansible_hostname }}
      
  - name: Update and upgrade apt packages
    become: true
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 #One day      
      
      
  - name: Install required packages
    become: true
    apt:
      name:
        - gnupg2
        - wget
        - acl
      state: latest         
                
  - name: Install python3
    become: true
    apt:
      name:
        - python3
        - python3-psycopg2
      state: latest      

  - name: Set up Postgres 14 repo
    become: true
    shell: |
      echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
      wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
    args:
      warn: no
      
  - name: Install postgresql
    become: true
    apt:
      name: postgresql-14
      update_cache: yes
    notify:
      - Enable Postgresql
      
  - name: Install zabbix packages
    become: true
    apt:
      name:
        - zabbix-server-pgsql 
        - zabbix-frontend-php
        - php7.4-pgsql
      state: latest   
      
  - name: Set up zabbix-agent
    become: true
    shell: |
      sudo apt install zabbix-nginx-conf zabbix-sql-scripts zabbix-agent
    args:
      warn: no